---
title: Using Hugo and Travis CI To Deploy Blog To Github Pages Automatically
slug: Using Hugo and Travis CI To Deploy Blog To Github Pages Automatically
date: 2018-04-11T00:20:07-04:00
lastmod: 2019-04-26T12:34:35-04:00
draft: false
keywords: ["Hugo", "Travis CI", "GitHub Pages", "Git", "Automatic deployment"]
description: "Using Hugo and Travis CI to deploy personal blog to Github pages automatically"

categories:
- Blog
tags:
- Github
- Hugo
- Travis CI
- Git

comment: true
toc: true

---

My personal static blog is hosted on [Github][github]. I used [Hexo][hexo] before, but as its complicated package dependence and cumbersome deployment process, I have to [encapsulate the whole deployment environment into Docker image]({{< relref "2016-06-16-Using-Docker-Container-To-Auto-Deploy-Blog-To-GitHub-Pages.md" >}}) for rapid deployment. But it was still too complex. Now I switch to [Hugo][hugo] which is faster, simpler.

This article documents how to automatically synchronize blog contents generated by [Hugo][hugo] to [Github][github] through [Travis CI][travisci].

<!--more-->

This article is one of my *personal static blog build series*:

1. [**Using Hugo and Travis CI To Deploy Blog To Github Pages Automatically**]({{< relref "2018-04-10-Using-Hugo-and-Travis-CI-To-Deploy-Blog-To-Github-Pages-Automatically.md" >}})
2. [Using Cloudflare Free SSL In GitHub Pages With Custom Domain]({{< relref "2018-04-11-Using-Cloudflare-Free-SSL-In-GitHub-Pages-With-Custom-Domain.md" >}})
3. [Setting Up Slack Build Notification in Travis CI for Github Project]({{< relref "2018-04-18-Setting-Up-Slack-Build-Notification-In-Travis-CI-For-Github-Project.md" >}})


**Attention**: The following operation process will not involve account registration, Git configuration.

## Prerequisite
1. Registering a [Github][github] account;
2. Registering a [Travis CI][travisci] account (login with Github account);
3. Installing `git`, `hugo` in your system;
4. Personal domain (optional, here my domain is `axdlog.com`);

## Official Docs
The relevant operations in this document are based on the official document as the operation guides:

* Github
    * [GitHub Pages Basics](https://help.github.com/categories/github-pages-basics/)
    * [User, Organization, and Project Pages](https://help.github.com/articles/user-organization-and-project-pages/)
    * [Creating Project Pages using the command line](https://help.github.com/articles/creating-project-pages-using-the-command-line/)
    * [Configuring a publishing source for GitHub Pages](https://help.github.com/articles/configuring-a-publishing-source-for-github-pages/)
* Hugo
    * [Host on GitHub](https://gohugo.io/hosting-and-deployment/hosting-on-github/)
* Travis CI
    * [GitHub Pages Deployment][travisci-github-page]
    * [Building a Python Project](https://docs.travis-ci.com/user/languages/python/)
    * [Best Practices in Securing Your Data](https://docs.travis-ci.com/user/best-practices-security/)
    * [Customizing the Build](https://docs.travis-ci.com/user/customizing-the-build/)


## Hugo Installation
* Github url: <https://github.com/gohugoio/hugo>
* Downloading page: <https://github.com/gohugoio/hugo/releases>
* Release Info API:  <https://api.github.com/repos/gohugoio/hugo/releases/latest>

[Install Hugo](https://gohugo.io/getting-started/installing/) is the official installation document of [Hugo][hugo]. If you're using GNU/Linux, you may consider using my Python script to install it quickly.

Current release version info

```bash
# which hugo
/usr/local/bin/hugo

# hugo version
Hugo Static Site Generator v0.55.4-57900417 linux/amd64 BuildDate: 2019-04-25T07:38:50Z
```

### Python Script
This Python script is used to install or upgrade [Hugo][hugo] on GNU/Linux.

{{< gist MaxdSre 0eb815348174538b2b75c0918dce0360 >}}

operating process

```bash
# sudo python3 ~/hugo.py
uccessfully download pack /tmp/hugo_0.55.4_Linux-64bit.tar.gz!
Successfully install Hugo v0.55.4!

Symlink info:
lrwxrwxrwx 1 root root 14 Apr 26 12:26 /usr/local/bin/hugo -> /opt/Hugo/hugo

Hugo info:
Hugo Static Site Generator v0.55.4-57900417 linux/amd64 BuildDate: 2019-04-25T07:38:50Z

# sudo python3 ~/hugo.py
Latest version 0.55.4 existed.

Hugo info:
Hugo Static Site Generator v0.55.4-57900417 linux/amd64 BuildDate: 2019-04-25T07:38:50Z
```


### Create A New Site
You can reference official document [Get Started](https://gohugo.io/getting-started/)、[Quick Start](https://gohugo.io/getting-started/quick-start/) to know how to create a new site through [Hugo][hugo].


>If this is your first time using Hugo and you’ve [already installed Hugo on your machine](https://gohugo.io/getting-started/installing/), we recommend the [quick start](https://gohugo.io/getting-started/quick-start/).

Here I name the site to `quickstart` (it is just the directory name, not the final site name).

Generated directory structure by Hugo:

```bash
# tree -L 2
.
├── archetypes
│   └── default.md
├── config.toml
├── content
├── data
├── layouts
├── static
└── themes

6 directories, 2 files
```

**Attention**: These files are not the final blog contents, they are just used to generate the blog contents.

Directory `content` is used to store your blog file (Markdown file).

If you wanna preview the final effect, just executing command `hugo server` to set up a local server which is listening port `1313`. And opening the link in your browser.

```bash
Web Server is available at http://localhost:1313/ (bind address 127.0.0.1)
Press Ctrl+C to stop
```

Executing command `hugo` in your project directory, it will generate a directory named `public`. This directory contains the final blog contents. What you need to do is push all the files in this directory to the branch `master` of your GitHub repository.

The demonstration process is as follows:

```bash
# hugo

                   | EN   
+------------------+-----+
  Pages            | 426  
  Paginator pages  |  24  
  Non-page files   |   0  
  Static files     |  34  
  Processed images |   0  
  Aliases          |  95  
  Sitemaps         |   1  
  Cleaned          |   0  

Total in 403 ms

# tree -L 1
.
├── archetypes
├── config.toml
├── content
├── data
├── layouts
├── public
├── resources
├── static
└── themes

8 directories, 1 file
```


## Github Repository Operation
**Important**: The handling ideas and operations of this section are very important. Not involving Git setting procedure.

If you use Github Page to host blog, you need to create a repository named `<username>.github.io`. Then putting the files generated by Hugo to the branch `master` of this repository.

I create 2 branches via command `git checkout --orphan` to store source files and blog contents in directory `public` separately.

* branch `code` stores source files;
* branch `master` stores blog contents in directory `public`;

Attention please, this method is different from official document [Configuring a publishing source for GitHub Pages](https://help.github.com/articles/configuring-a-publishing-source-for-github-pages/).


### Create Empty Repository
My GitHub account is `MaxdSre`, so I need to create a repository named `maxdsre.github.io`.

After creating the repository, it will prompts

>or create a new repository on the command line

```bash
echo "# maxdsre.github.io" >> README.md
git init
git add README.md
git commit -m "first commit"
git remote add origin git@github.com:MaxdSre/maxdsre.github.io.git
git push -u origin master
```

>or push an existing repository from the command line

```bash
git remote add origin git@github.com:MaxdSre/maxdsre.github.io.git
git push -u origin master
```

### Pushing Repository
There are 4 steps:

1. Initializing Git repository via command `git init` in project directory;
2. Creating branch `code`, pushing source files to remote repository;
3. Executing command `hugo` to generate `public` directory; Transferring all the files in this directory to another temporary directory, empty project directory, then move the files store in temporary directory back to project directory;
4. Creating branch `master` via command `git checkout --orphan`, then pushing all files store in current directory to remote repository.

Entering the target directory (here is `/PATH/quickstart/`), then executing the following commands in sequence.

#### Branch code
```bash
# Initialized empty Git repository in /PATH/.git/
git init

# Switched to a new branch 'code', equal to 'git branch code && git checkout code'
git checkout -b code

# exclude dir public/
echo '/public/' >> .gitignore
sed -r -i '/^\/public\/$/{$!d}' .gitignore

# Add file contents to the index
git add .

# Show the working tree status
# git status

# Record changes to the repository
git commit -m "Hugo generator code"

# Manage set of tracked repositories
git remote add origin git@github.com:MaxdSre/maxdsre.github.io.git

# Update remote refs along with associated objects to branch 'code'
git push -u origin code
```

#### Branch master
Executing command `hugo` in project directly to generate directly `public`. If you wanna check the branch info of this repository, just executing command `git branch -a`.

```bash
# execute command hugo
hugo

# create temporary dir
HUGO_TEMP_DIR=$(mktemp -d)
cp -R public/* "$HUGO_TEMP_DIR"

# create orphan branch 'master'
git checkout --orphan master

# empty current dir
rm .git/index
git clean -fdx

# copy back contents in dir public/
cp -R "$HUGO_TEMP_DIR"/. .

# add, commit, push
git add .
# git status
git commit -m 'initial blog content'
git push -u origin master

# remove temp dir
[[ -d "$HUGO_TEMP_DIR" ]] && rm -rf "$HUGO_TEMP_DIR"
```

#### Branch image
This section is optional. In order to store images in GitHub directly, I create the third branch `image`. All images used in blog will be saved in this branch.

```bash
git checkout --orphan image
rm .git/index
git clean -fdx

# add content to this branch

git add .
git commit -m 'initial blog images'
git push -u origin image

# fatal: The current branch image has no upstream branch.
# To push the current branch and set the remote as upstream, use
# git push --set-upstream origin image
```

### Switching branch
If you wanna switch your local branch to remote branch `remotes/origin/image`, you may consider executing the following command

```bash
# git checkout -b <branch> --track <remote>/<branch>
# -b <new_branch>    Create a new branch named <new_branch> and start it at <start_point>;
# -t, --track     When creating a new branch, set up "upstream" configuration.

git checkout -t remotes/origin/image

# local branch, switch from other branch to branch 'code'
git checkout code
```

Demonstration example

```bash
# git branch
* code

# git branch -a
* code
  remotes/origin/HEAD -> origin/code
  remotes/origin/code
  remotes/origin/image
  remotes/origin/master

# git checkout -t remotes/origin/image
Branch 'image' set up to track remote branch 'image' from 'origin'.
  Switched to a new branch 'image'

# git branch
  code
* image

# git branch -a
  code
* image
  remotes/origin/HEAD -> origin/code
  remotes/origin/code
  remotes/origin/image
  remotes/origin/master
```

### Deleting branch
Deleting branches has three types: *remote branch*, *local branch*, *local remote-tracking branch*, more details in [How do I delete a Git branch both locally and remotely?](https://stackoverflow.com/questions/2003505/how-do-i-delete-a-git-branch-both-locally-and-remotely#answer-23961231).


```bash
# 1 - Delete a remote branch
$ git push origin --delete <branch> # Git version 1.7.0 or newer
$ git push origin :<branch> # Git versions older than 1.7.0

# 2 - Delete a local branch
$ git branch --delete <branch>
$ git branch -d <branch> # Shorter version

$ git branch -D <branch> # Force delete un-merged branches

# error: The branch 'image' is not fully merged.
# If you are sure you want to delete it, run 'git branch -D image'.

# 3 - Delete a local remote-tracking branch
$ git branch --delete --remotes <remote>/<branch>
$ git branch -dr <remote>/<branch> # Shorter

$ git fetch <remote> --prune # Delete multiple obsolete tracking branches
$ git fetch <remote> -p # Shorter
```


## Travis CI Configuration
[GitHub Pages Deployment][travisci-github-page] is the official document of [Travis CI][travisci]。

### Github Access Token Generation
> You’ll need to generate a [personal access token](https://help.github.com/articles/creating-an-access-token-for-command-line-use/) with the public_repo or repo scope (repo is required for private repositories). Since the token should be private, you’ll want to pass it to Travis securely in your [repository settings](https://docs.travis-ci.com/user/environment-variables#Defining-Variables-in-Repository-Settings) or via [encrypted variables](https://docs.travis-ci.com/user/environment-variables#Defining-encrypted-variables-in-.travis.yml) in .travis.yml.


Generating `personal access tokens` in GitHub page [Developer settings](https://github.com/settings/tokens). If it is a private repository, choose `repo`. Otherwise, just choose `public_repo`. Here I choose `public_repo`, `repo:status`, `repo_deployment`.

The length of the generated token is 40, please keep is private.

![](https://raw.githubusercontent.com/MaxdSre/maxdsre.github.io/image/blog-image/2018-04-10-go_travisci_github_page/2018-04-11_00-13-54-github-access-token.png)


### Environment Variables Setting
Generated `token` is used in [Travis CI][travisci], the page url of target repository in [Travis CI][travisci] is  <https://travis-ci.org/MaxdSre/maxdsre.github.io/settings>.

![](https://raw.githubusercontent.com/MaxdSre/maxdsre.github.io/image/blog-image/2018-04-10-go_travisci_github_page/2018-04-11_00-11-05-travisci-system-var-setting.png)

Don't forget to check `Build only if .travis.yml is present`, `Build pushed branches`, `Build pushed pull requests`.

![](https://raw.githubusercontent.com/MaxdSre/maxdsre.github.io/image/blog-image/2018-04-10-go_travisci_github_page/2018-04-11_00-10-39-travisci-general-setting.png)

The default name of `token` defined in official document [GitHub Pages Deployment][travisci-github-page] is `GITHUB_TOKEN`, this document alse lists other directives.

> Notice that the values are not escaped when your builds are executed. Special characters (for bash) should be escaped accordingly.

Defining variables, it will be used in file `.travis.yml` latter.

Environment Variables | Value
---|---
CNAME_URL | axdlog.com
GITHUB_USERNAME | MaxdSre
GITHUB_EMAIL | admin@axdlog.com (pseudo value)
GITHUB_TOKEN | 75e8b7y318ebf48df0bc35cp4affd79e167b2489 (pseudo value)


### .travis.yml directives
[Hugo][hugo] is written by Golang. If I chose `language: go` in `.travis.yml`, the process of build Golang environment costed too much time (a few minutes).

~~I find someone use Python to deploy successfully, then chose Python as operation environment. As the containers of [Travis CI][travisci] is based on Ubuntu, I can use command `dpkg`, `apt-get`, but it needs `sudo` privilege.~~

As Python failed to build frequently, because GitHub forbided HTTP request from Travis container. I solve this problem via `tor` proxy.

The final code is as follow

#### Python

```yml
# https://docs.travis-ci.com/user/deployment/pages/
# https://docs.travis-ci.com/user/reference/xenial/
# https://docs.travis-ci.com/user/languages/python/
# https://docs.travis-ci.com/user/customizing-the-build/

dist: xenial
language: python
python:
  - "3.7"

before_install:
  - sudo apt-get update -qq
  - sudo apt-get -yq install apt-transport-https tor curl

# install - install any dependencies required
install:
    # install latest release version
    # Github may forbid request from travis container, so use tor proxy
    - sudo systemctl start tor
    # - curl -fsL --socks5-hostname 127.0.0.1:9050 https://api.github.com/repos/gohugoio/hugo/releases/latest | sed -r -n '/browser_download_url/{/Linux-64bit.deb/{s@[^:]*:[[:space:]]*"([^"]*)".*@\1@g;p;q}}' | xargs wget
    - download_command='curl -fsSL -x socks5h://127.0.0.1:9050' # --socks5-hostname
    - $download_command -O $($download_command https://api.github.com/repos/gohugoio/hugo/releases/latest | sed -r -n '/browser_download_url/{/Linux-64bit.deb/{s@[^:]*:[[:space:]]*"([^"]*)".*@\1@g;p;q}}')
    - sudo dpkg -i hugo*.deb
    - rm -rf public 2> /dev/null

# script - run the build script
script:
    - hugo
    - echo "$CNAME_URL" > public/CNAME

deploy:
  provider: pages
  skip-cleanup: true
  github-token: $GITHUB_TOKEN  # Set in travis-ci.org dashboard, marked secure
  email: $GITHUB_EMAIL
  name: $GITHUB_USERNAME
  verbose: true
  keep-history: true
  local-dir: public
  target_branch: master  # branch contains blog content
  on:
    branch: code  # branch contains Hugo generator code
```

#### Golang (deprecated)

```yml
# https://docs.travis-ci.com/user/deployment/pages/
# https://docs.travis-ci.com/user/reference/xenial/
# https://docs.travis-ci.com/user/languages/go/
# https://docs.travis-ci.com/user/customizing-the-build/

dist: xenial
language: go
go:
    - master

# before_install
# install - install any dependencies required
install:
    - go get github.com/gohugoio/hugo    # consume time 70.85s

before_script:
    - rm -rf public 2> /dev/null

# script - run the build script
script:
    - hugo
    - echo "$CNAME_URL" > public/CNAME

deploy:
  provider: pages
  skip-cleanup: true
  github-token: $GITHUB_TOKEN  # Set in travis-ci.org dashboard, marked secure
  email: $GITHUB_EMAIL
  name: $GITHUB_USERNAME
  verbose: true
  keep-history: true
  local-dir: public
  target_branch: master  # branch contains blog content
  on:
    branch: code  # branch contains Hugo generator code
```


Writing it into file `.travis.yml`, and push file `.travis.yml` to the branch `code` of remote repository.


## Continuous Integration
After all operations are finished. If you push your changed source file to branch `code`. [Travis CI][travisci] will automatically execute directives defined in file `.travis.yml`, then pushing the generated blog contents to branch `master`.

![](https://raw.githubusercontent.com/MaxdSre/maxdsre.github.io/image/blog-image/2018-04-10-go_travisci_github_page/2018-04-11_00-35-56-travisci-deploy-status.png)

Deploying log

![](https://raw.githubusercontent.com/MaxdSre/maxdsre.github.io/image/blog-image/2018-04-10-go_travisci_github_page/2018-04-11_00-36-29-travisci-deploy-log.png)

![](https://raw.githubusercontent.com/MaxdSre/maxdsre.github.io/image/blog-image/2018-04-10-go_travisci_github_page/2018-04-11_00-36-57-travisci-deploy-log.png)


## References
* [Continuous Integration of Hugo Website using Travis CI and Github](https://jellis18.github.io/post/2017-12-03-continuous-integration-hugo/)
* [Travis continuous delivery](https://github.com/ldez/travis-continuous-delivery-hugo-deploy)
* [How to create a website like freshswift.net using Hugo, Travis CI, and GitHub Pages](https://medium.com/zendesk-engineering/how-to-create-a-website-like-freshswift-net-using-hugo-travis-ci-and-github-pages-67be6f480298)
* [GitLab CI remove priority zero from Hugo sitemap](https://www.leowkahman.com/2017/09/10/gitlab-ci-remove-priority-zero-from-hugo-sitemap/)
* [Deploy Hugo site to Github Pages with Travis CI](https://leonidboykov.com/post/hugo-github-travis/)


## Change logs
* 2018.04.11 00:20 Wed America/Boston
    * first draft
* 2018.07.11 12:20 Wed America/Boston
    * add python script for hugo installation
* 2018.08.03 08:44 Fri Asia/Shanghai
    * add switch branch
* 2018.12.04 11:46 Tue America/Boston
    * use Golang in travis
* 2019.01.30 09:38 Wed America/Boston
    * still use Python in travis, short time consuming
* 2019.04.05 22:44 Fri America/Boston
    * update hugo version to `v0.54.0`
* 2019.04.26 12:33 Fri America/Boston
    * update hugo version to `v0.55.4`


[hexo]: https://hexo.io "A fast, simple & powerful blog framework"
[hugo]: https://gohugo.io "The world’s fastest framework for building websites"
[github]: https://github.com
[travisci]: https://travis-ci.org "Test and Deploy with Confidence"
[travisci-github-page]: https://docs.travis-ci.com/user/deployment/pages/ "Travis CI - GitHub Pages Deployment"


<!-- End -->
